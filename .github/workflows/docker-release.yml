name: Release Docker image to Fly

on:
  push:
    tags:
      - "v*"

jobs:
  docker-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JFrog CLI with OIDC (Fly)
        uses: jfrog/setup-jfrog-cli@v4
        with:
          oidc-provider-name: github
          jfrog-url: ${{ vars.FLY_URL }}

      - name: Derive image metadata
        id: meta
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          REPO_LC=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "name=$REPO_LC" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Check for Dockerfile
        id: dockerfile
        run: |
          if [ -f Dockerfile ]; then echo "present=true" >> $GITHUB_OUTPUT; else echo "present=false" >> $GITHUB_OUTPUT; fi

      - name: Set up Docker Buildx
        if: steps.dockerfile.outputs.present == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Docker login to Fly via JFrog CLI
        if: steps.dockerfile.outputs.present == 'true'
        run: |
          jf rt docker-login

      - name: Build image
        if: steps.dockerfile.outputs.present == 'true'
        env:
          IMAGE_NAME: ${{ vars.IMAGE_NAME }}
        run: |
          NAME="${IMAGE_NAME:-${{ steps.meta.outputs.name }}}"
          TAG="${{ steps.meta.outputs.tag }}"
          docker build -t "$NAME:$TAG" .

      - name: Push image to Fly via JFrog CLI
        if: steps.dockerfile.outputs.present == 'true'
        env:
          FLY_DOCKER_REPO: ${{ vars.FLY_DOCKER_REPO }}
        run: |
          if [ -z "$FLY_DOCKER_REPO" ]; then
            echo "FLY_DOCKER_REPO repository variable is not set." >&2
            exit 1
          fi
          NAME="${{ steps.meta.outputs.name }}"
          TAG="${{ steps.meta.outputs.tag }}"
          jf rt docker-push "$NAME:$TAG" "$FLY_DOCKER_REPO"


